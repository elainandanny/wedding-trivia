<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Wedding Trivia</title>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.24.7/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            "custom-blue": "#8cabc0",
          },
        },
      },
    };
  </script>

  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore-compat.js"></script>
</head>

<body class="bg-gray-200 min-h-screen flex items-center justify-center">
  <div id="root"></div>

<script type="text/babel">
/* =================== FIREBASE =================== */
const firebaseConfig = {
  apiKey: "AIzaSyD-uMdBpQhau_mQRQwtUqDbNqlPR8LVfq4",
  authDomain: "wedding-trivia-test.firebaseapp.com",
  projectId: "wedding-trivia-test",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* =================== HELPERS =================== */
const shuffle = (arr) => [...arr].sort(() => Math.random() - 0.5);

const formatTime = (s) => `${s.toFixed(2)}s`;

/* =================== APP =================== */
function TriviaGame() {
  const [gameState, setGameState] = React.useState("language");
  const [language, setLanguage] = React.useState(null);
  const [fullName, setFullName] = React.useState("");
  const [nameSelected, setNameSelected] = React.useState(false);
  const [names, setNames] = React.useState([]);
  const [filteredNames, setFilteredNames] = React.useState([]);
  const [showDropdown, setShowDropdown] = React.useState(false);
  const [gameMode, setGameMode] = React.useState(null);
  const [questions, setQuestions] = React.useState([]);
  const [shuffledQuestions, setShuffledQuestions] = React.useState([]);
  const [currentQuestion, setCurrentQuestion] = React.useState(0);
  const [score, setScore] = React.useState(0);
  const [totalTime, setTotalTime] = React.useState(0);
  const inputRef = React.useRef(null);

  /* ---------- LOAD NAMES ---------- */
  React.useEffect(() => {
    if (!language) return;
    fetch("https://raw.githubusercontent.com/elainandanny/wedding-trivia/main/names.csv")
      .then(r => r.text())
      .then(text => {
        const data = Papa.parse(text, { header: true }).data;
        const clean = data
          .map(r => r.First && r.Last ? `${r.First.trim()} ${r.Last.trim()}` : null)
          .filter(Boolean);
        setNames(clean);
        setFilteredNames(clean);
      });
  }, [language]);

  /* ---------- LOAD QUESTIONS ---------- */
  React.useEffect(() => {
    if (!language) return;
    const url =
      language === "en"
        ? "https://raw.githubusercontent.com/elainandanny/wedding-trivia/main/English_Questions.csv"
        : "https://raw.githubusercontent.com/elainandanny/wedding-trivia/main/Chinese_Questions.csv";

    fetch(url)
      .then(r => r.text())
      .then(text => {
        const data = Papa.parse(text, { header: true }).data;
        const parsed = data.filter(
          r =>
            r.Question &&
            r.Correct_Answer &&
            r.Incorrect_Answer_1 &&
            r.Incorrect_Answer_2 &&
            r.Incorrect_Answer_3
        );
        setQuestions(parsed);
      });
  }, [language]);

  /* ---------- FILTER NAMES ---------- */
  React.useEffect(() => {
    if (!fullName || nameSelected) {
      setShowDropdown(false);
      return;
    }
    const filtered = names.filter(n =>
      n.toLowerCase().includes(fullName.toLowerCase())
    );
    setFilteredNames(filtered);
    setShowDropdown(filtered.length > 0);
  }, [fullName, names, nameSelected]);

  /* ---------- GAME START ---------- */
  const startGame = () => {
    const count = gameMode === "mini" ? 10 : questions.length;
    setShuffledQuestions(shuffle(questions).slice(0, count));
    setScore(0);
    setCurrentQuestion(0);
    setTotalTime(0);
    setGameState("playing");
  };

  /* ---------- ANSWER ---------- */
  const answer = (correct) => {
    if (correct) setScore(s => s + 1);
    if (currentQuestion + 1 < shuffledQuestions.length) {
      setCurrentQuestion(c => c + 1);
    } else {
      setGameState("result");
    }
  };

  /* =================== UI =================== */
  return (
    <div className="bg-white p-8 rounded-lg shadow-lg max-w-md w-full text-center">

      {gameState === "language" && (
        <div className="space-y-4">
          <button onClick={() => { setLanguage("en"); setGameState("menu"); }} className="btn">English</button>
          <button onClick={() => { setLanguage("zh"); setGameState("menu"); }} className="btn">中文</button>
        </div>
      )}

      {gameState === "menu" && (
        <>
          <h1 className="text-3xl font-bold text-custom-blue leading-tight mb-6">
            Elaina and Danny&apos;s<br />Wedding Trivia
          </h1>
          <button onClick={() => setGameState("mode")} className="btn">Play</button>
        </>
      )}

      {gameState === "mode" && (
        <div className="space-y-4">
          <button onClick={() => { setGameMode("mini"); setGameState("name"); }} className="btn">
            Mini (10Q)
          </button>
          <button onClick={() => { setGameMode("full"); setGameState("name"); }} className="btn">
            Full ({questions.length || "All"}Q)
          </button>
        </div>
      )}

      {gameState === "name" && (
        <>
          <input
            ref={inputRef}
            value={fullName}
            onChange={(e) => {
              setFullName(e.target.value);
              setNameSelected(false);
            }}
            className="border p-2 w-full"
            placeholder="Full Name"
          />

          {showDropdown && (
            <ul className="border mt-1 bg-white max-h-40 overflow-y-auto">
              {filteredNames.map((n, i) => (
                <li
                  key={i}
                  onClick={() => {
                    setFullName(n);
                    setNameSelected(true);
                    setShowDropdown(false);
                  }}
                  className="p-2 hover:bg-gray-200 cursor-pointer"
                >
                  {n}
                </li>
              ))}
            </ul>
          )}

          <button onClick={startGame} className="btn mt-4">Start</button>
        </>
      )}

      {gameState === "playing" && (
        <>
          <p className="mb-2">Welcome, {fullName}!</p>
          <p className="mb-4 text-custom-blue font-semibold">
            How well do you know Elaina & Danny?
          </p>

          <p className="mb-4">
            {shuffledQuestions[currentQuestion].Question}
          </p>

          {shuffle([
            { t: shuffledQuestions[currentQuestion].Correct_Answer, c: true },
            { t: shuffledQuestions[currentQuestion].Incorrect_Answer_1, c: false },
            { t: shuffledQuestions[currentQuestion].Incorrect_Answer_2, c: false },
            { t: shuffledQuestions[currentQuestion].Incorrect_Answer_3, c: false },
          ]).map((o, i) => (
            <button key={i} onClick={() => answer(o.c)} className="btn mb-2">
              {o.t}
            </button>
          ))}
        </>
      )}

      {gameState === "result" && (
        <>
          <h2 className="text-xl font-bold mb-4">Game Over!</h2>
          <p>
            Score: {score} / {shuffledQuestions.length}
          </p>
        </>
      )}
    </div>
  );
}

const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(<TriviaGame />);
</script>

<style>
.btn {
  background:#8cabc0;
  color:white;
  padding:0.75rem;
  width:100%;
  border-radius:0.5rem;
}
.btn:hover { opacity:0.85; }
</style>

</body>
</html>
